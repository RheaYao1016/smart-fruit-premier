import{D as K,f as S,E as v,S as m,i as U}from"./index-D_8ZP-ZB.js";function D(r){return`${r}_${Date.now()}_${Math.random().toString(16).slice(2,6)}`}const J=K("community",()=>{const r=S(v.get(m.posts,[])),c=S(v.get(m.comments,[])),o=S(v.get(m.likes,[])),d=S(v.get(m.favorites,[])),g=S(v.get(m.reports,[])),b=U(()=>r.value.length);function l(){v.set(m.posts,r.value),v.set(m.comments,c.value),v.set(m.likes,o.value),v.set(m.favorites,d.value),v.set(m.reports,g.value)}function p(e){return o.value.filter(t=>t.postId===e).length}function w(e){return c.value.filter(t=>t.postId===e).length}function I(e,t){return t?o.value.some(s=>s.postId===e&&s.userId===t):!1}function P(e,t){return t?d.value.some(s=>s.postId===e&&s.userId===t):!1}function x(e){return r.value.find(t=>t.id===e)||null}function B(e){return c.value.filter(t=>t.postId===e).sort((t,s)=>new Date(t.createdAt).getTime()-new Date(s.createdAt).getTime())}function k(e,t){return{...e,likeCount:p(e.id),commentCount:w(e.id),favoriteCount:d.value.filter(s=>s.postId===e.id).length,isLiked:I(e.id,t),isFavorited:P(e.id,t),hotScore:p(e.id)*2+w(e.id)}}function E({userId:e,role:t,search:s="",sort:n="latest",tag:i="全部",page:u=1,pageSize:h=10}={}){const C=String(s||"").trim().toLowerCase();let A=r.value.filter(a=>t!=="admin"&&!(!a.isHidden&&(a.isApproved||a.authorId===e))||i&&i!=="全部"&&(!Array.isArray(a.tags)||!a.tags.includes(i))?!1:C?[a.title,a.content,...a.tags||[]].join(" ").toLowerCase().includes(C):!0);A=A.map(a=>k(a,e)),n==="hot"?A.sort((a,f)=>f.hotScore-a.hotScore||new Date(f.createdAt)-new Date(a.createdAt)):n==="featured"?A.sort((a,f)=>Number(f.isPinned)-Number(a.isPinned)||new Date(f.createdAt)-new Date(a.createdAt)):(A.sort((a,f)=>new Date(f.createdAt)-new Date(a.createdAt)),A.sort((a,f)=>Number(f.isPinned)-Number(a.isPinned)));const y=A.length,O=(u-1)*h,L=O+h;return{total:y,page:u,pageSize:h,hasMore:L<y,items:A.slice(O,L)}}function F(e,t){if(!(t!=null&&t.id))return{success:!1,message:"未登录"};if(!e.title||!e.content)return{success:!1,message:"标题和正文必填"};const s={id:D("p"),authorId:t.id,title:e.title,content:e.content,tags:Array.isArray(e.tags)?e.tags:[],images:Array.isArray(e.images)?e.images.filter(Boolean).slice(0,9):[],recipe:e.recipe||null,isPinned:!1,isHidden:!1,isApproved:t.role==="admin",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return r.value.unshift(s),l(),{success:!0,data:s}}function H(e,t,s){const n=r.value.findIndex(h=>h.id===e);if(n<0)return{success:!1,message:"帖子不存在"};const i=r.value[n];return(s==null?void 0:s.role)==="admin"||i.authorId===(s==null?void 0:s.id)?(r.value[n]={...i,...t,updatedAt:new Date().toISOString()},l(),{success:!0,data:r.value[n]}):{success:!1,message:"无权限编辑"}}function N(e,t){const s=x(e);return s?(t==null?void 0:t.role)==="admin"||s.authorId===(t==null?void 0:t.id)?(r.value=r.value.filter(i=>i.id!==e),c.value=c.value.filter(i=>i.postId!==e),o.value=o.value.filter(i=>i.postId!==e),d.value=d.value.filter(i=>i.postId!==e),g.value=g.value.filter(i=>i.postId!==e),l(),{success:!0}):{success:!1,message:"无权限删除"}:{success:!1,message:"帖子不存在"}}function R(e,t){if(!t)return{success:!1,message:"请先登录"};const s=o.value.findIndex(n=>n.postId===e&&n.userId===t);return s>=0?(o.value.splice(s,1),l(),{success:!0,liked:!1}):(o.value.push({id:D("l"),postId:e,userId:t,createdAt:new Date().toISOString()}),l(),{success:!0,liked:!0})}function T(e,t){if(!t)return{success:!1,message:"请先登录"};const s=d.value.findIndex(n=>n.postId===e&&n.userId===t);return s>=0?(d.value.splice(s,1),l(),{success:!0,favorited:!1}):(d.value.push({id:D("f"),postId:e,userId:t,createdAt:new Date().toISOString()}),l(),{success:!0,favorited:!0})}function _({postId:e,userId:t,content:s,parentId:n=null}){return!s||!String(s).trim()?{success:!1,message:"评论不能为空"}:(c.value.push({id:D("c"),postId:e,userId:t,content:String(s).trim(),parentId:n,createdAt:new Date().toISOString()}),l(),{success:!0})}function $(e,t){const s=c.value.find(i=>i.id===e);return s?(t==null?void 0:t.role)==="admin"||(t==null?void 0:t.id)===s.userId?(c.value=c.value.filter(i=>i.id!==e),l(),{success:!0}):{success:!1,message:"无权限"}:{success:!1,message:"评论不存在"}}function M({postId:e,reporterId:t,reason:s,description:n}){return s?g.value.find(u=>u.postId===e&&u.reporterId===t&&u.status==="pending")?{success:!1,message:"你已提交过待处理举报"}:(g.value.push({id:D("r"),postId:e,reporterId:t,reason:s,description:n||"",status:"pending",createdAt:new Date().toISOString(),handledBy:null,handledAt:null,result:""}),l(),{success:!0}):{success:!1,message:"请选择举报原因"}}function j(e,t,s){if((s==null?void 0:s.role)!=="admin")return{success:!1,message:"仅管理员可操作"};const n=r.value.findIndex(i=>i.id===e);return n<0?{success:!1,message:"帖子不存在"}:(t==="approve"&&(r.value[n].isApproved=!0),t==="hide"&&(r.value[n].isHidden=!0),t==="show"&&(r.value[n].isHidden=!1),t==="pin"&&(r.value[n].isPinned=!r.value[n].isPinned),r.value[n].updatedAt=new Date().toISOString(),l(),{success:!0})}function q({reportId:e,result:t,handlerId:s}){const n=g.value.findIndex(i=>i.id===e);return n<0?{success:!1,message:"举报不存在"}:(g.value[n]={...g.value[n],status:"resolved",handledBy:s,handledAt:new Date().toISOString(),result:t||"已处理"},l(),{success:!0})}function G(e){const t=r.value.filter(u=>u.authorId===e),s=o.value.filter(u=>u.userId===e),n=d.value.filter(u=>u.userId===e),i=c.value.filter(u=>u.userId===e);return{myPosts:t,likedPosts:r.value.filter(u=>s.some(h=>h.postId===u.id)),favoritePosts:r.value.filter(u=>n.some(h=>h.postId===u.id)),myComments:i}}return{posts:r,comments:c,likes:o,favorites:d,reports:g,postCount:b,queryPosts:E,buildPostView:k,getPostById:x,getCommentsByPost:B,createPost:F,updatePost:H,deletePost:N,toggleLike:R,toggleFavorite:T,addComment:_,deleteComment:$,addReport:M,moderatePost:j,handleReport:q,getUserContent:G,countLikes:p,countComments:w,isLiked:I,isFavorited:P}});export{J as u};
